<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Noodknop & Status Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: white;
        padding: 20px;
    }

    .card {
        background: #222;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
    }

    input, select, button {
        padding: 10px;
        margin-top: 10px;
        width: 100%;
        border-radius: 8px;
        border: none;
    }

    button {
        background: #2979ff;
        color: white;
        font-size: 18px;
        cursor: pointer;
    }

    button:hover {
        background: #1c54b2;
    }

    #noodBtn {
        background: red;
        font-size: 22px;
        font-weight: bold;
    }

    #alertPopup {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255,0,0,0.9);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-size: 40px;
        font-weight: bold;
        padding: 20px;
        z-index: 9999;
    }

    .status-green { color: #00e676; }
    .status-orange { color: #ff9100; }
    .status-red { color: #ff1744; }
</style>
</head>
<body>

<h1>Nederbeek Noodknop Dashboard</h1>

<!-- NOODALARMSOUND -->
<audio id="alarmSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_655735ff2e.mp3?filename=warning-alarm-97916.mp3" preload="auto"></audio>

<div class="card" id="loginCard">
    <h2>Inloggen</h2>
    <input type="text" id="username" placeholder="Naam">
    <input type="text" id="roepnummer" placeholder="Roepnummer">
    <button onclick="login()">Login</button>
</div>

<div class="card" id="dashboard" style="display:none;">
    <h2>Welkom, <span id="userDisplay"></span></h2>

    <h3>Status wijzigen</h3>
    <select id="statusSelect" onchange="updateStatus()">
        <option value="1">1 - Inzetbaar</option>
        <option value="2">2 - Aanrijdend</option>
        <option value="3">3 - Ter plaatse</option>
        <option value="4">4 - Bezet</option>
        <option value="5">5 - Transport aanvraag</option>
        <option value="6">6 - Aanvraag OC</option>
        <option value="7">7 - Spoed OC</option>
        <option value="8">8 - Uitdienst</option>
    </select>

    <button onclick="toggleDienst()">In/Uit Dienst</button>

    <button id="noodBtn" onclick="triggerNood()">NOODKNOP</button>
</div>

<div class="card">
    <h2>Overzicht medewerkers (Live)</h2>
    <div id="liveList"></div>
</div>

<div id="alertPopup"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBa_2hGKhEH_dU6xDIfIjIO8_BlubM-JSc",
    authDomain: "politie-nederbeek-fd6ff.firebaseapp.com",
    databaseURL: "https://politie-nederbeek-fd6ff-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "politie-nederbeek-fd6ff",
    storageBucket: "politie-nederbeek-fd6ff.firebasestorage.app",
    messagingSenderId: "49112852872",
    appId: "1:49112852872:web:9b235d5e5dfd2c89aaf23d",
    measurementId: "G-5TVFPYEZMS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();

let currentUser = null;

//////////////////////
// LOGIN
//////////////////////

window.login = function () {
    const name = document.getElementById("username").value;
    const rn   = document.getElementById("roepnummer").value;

    if (!name || !rn) {
        alert("Vul naam en roepnummer in!");
        return;
    }

    signInAnonymously(auth).then(() => {
        currentUser = rn;

        update(ref(db, "gebruikers/" + rn), {
            naam: name,
            status: 1,
            dienst: "in",
            tijd: Date.now()
        });

        document.getElementById("loginCard").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("userDisplay").innerText = name + " (" + rn + ")";
    });
};

//////////////////////
// STATUS
//////////////////////

window.updateStatus = function () {
    const newStatus = document.getElementById("statusSelect").value;
    update(ref(db, "gebruikers/" + currentUser), {
        status: Number(newStatus),
        tijd: Date.now()
    });
};

window.toggleDienst = function () {
    const dienstRef = ref(db, "gebruikers/" + currentUser);

    onValue(dienstRef, (snap) => {
        const cur = snap.val();
        const newDienst = cur.dienst === "in" ? "uit" : "in";

        update(dienstRef, {
            dienst: newDienst,
            tijd: Date.now()
        });
    }, { onlyOnce: true });
};

//////////////////////
// NOODKNOP
//////////////////////

window.triggerNood = function () {
    // SPEEL GELUID DIRECT
    const alarm = document.getElementById("alarmSound");
    alarm.currentTime = 0;
    alarm.play().catch(err => console.log(err));

    update(ref(db, "noodmelding"), {
        actief: true,
        door: currentUser,
        tijd: Date.now()
    });
};

//////////////////////
// NOOD POPUP LIVE
//////////////////////

onValue(ref(db, "noodmelding"), (snap) => {
    const data = snap.val();
    const popup = document.getElementById("alertPopup");

    if (!data || !data.actief) {
        popup.style.display = "none";
        return;
    }

    popup.style.display = "flex";
    popup.innerHTML = `
        NOODKNOP INGEDRUKT!<br><br>
        Door: ${data.door}<br><br>
        <button style="
            padding: 15px; 
            font-size: 22px; 
            background:white;
            color:black;
            border:none;
            border-radius:8px;
        " onclick="clearNood()">NOODKNOP STOPPEN</button>
    `;
});

//////////////////////
// STOPKNOP
//////////////////////

window.clearNood = function () {
    update(ref(db, "noodmelding"), {
        actief: false,
        door: "",
        tijd: 0
    });

    const alarm = document.getElementById("alarmSound");
    alarm.pause();
    alarm.currentTime = 0;
};

//////////////////////
// LIVE LIJST
//////////////////////

onValue(ref(db, "gebruikers"), (snap) => {
    const list = snap.val();
    const container = document.getElementById("liveList");
    container.innerHTML = "";

    for (const key in list) {
        const u = list[key];

        let kleur = "white";
        if (u.status == 1) kleur = "#00e676";
        if (u.status == 4) kleur = "#ff9100";
        if (u.status == 7) kleur = "#ff1744";

        const div = document.createElement("div");
        div.style.color = kleur;
        div.innerHTML =
            `<strong>${u.naam}</strong> (${key}) — Status: ${u.status} — Dienst: ${u.dienst}`;
        
        container.appendChild(div);
    }
});
</script>

</body>
</html>
