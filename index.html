<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nederbeek â€” Meldkamer Dashboard</title>

<!-- =========================
     STIJL (Politie-stijl)
     ========================= -->
<style>
:root{
  --bg:#001b35;
  --card:#07243d;
  --muted:#a9c2d6;
  --accent:#ffc600;
  --accent-dark:#e0a700;
  --white:#ffffff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--white)}
.container{max-width:1200px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.title h1{margin:0;font-size:20px}
.title .sub{color:var(--muted);font-size:13px;margin-top:4px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#001b35;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.5)}
.field{margin-top:10px}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
.select-status{font-weight:700}
.huge{font-size:18px;padding:14px;border-radius:12px}
.nood{background:linear-gradient(180deg,#ff4d4f,#d32f2f);color:white;border:none}
.small{color:var(--muted);font-size:13px}
.ovd-list{max-height:420px;overflow:auto;margin-top:10px}
.row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px}
.row .left{display:flex;gap:12px;align-items:center}
.status-badge{min-width:120px;text-align:center;padding:8px;border-radius:8px;font-weight:700}
.ts{font-size:12px;color:var(--muted)}
.nav{display:flex;gap:8px;align-items:center;margin-left:8px}
.link{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px}
.link.active{background:rgba(255,255,255,0.04);color:var(--white)}
.footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

/* ALERT OVERLAY - knipperend */
#alertOverlay{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;
  background:linear-gradient(180deg,rgba(180,0,0,0.95),rgba(120,0,0,0.95));
  color:white;text-align:center;padding:20px;cursor:pointer;
  animation: pulse 0.8s infinite;
}
@keyframes pulse {0%{opacity:1}50%{opacity:0.2}100%{opacity:1}}
#alertOverlay h2{font-size:44px;margin:8px}
#alertOverlay p{font-size:20px;margin:6px}
#enableSound{background:#fff;color:#001b35;border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer}
.small-link{font-size:13px;color:var(--muted);text-decoration:underline;cursor:pointer}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.vta-actions button{margin-right:6px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1>Nederbeek â€” Meldkamer Dashboard</h1>
      <div class="sub">Realtime statussen â€¢ Noodknop â€¢ VTA beheer</div>
    </div>

    <div class="controls">
      <nav class="nav" aria-label="Hoofdmenu">
        <a href="#dashboard" class="link" id="navDashboard">Dashboard</a>
        <a href="#vtas" class="link" id="navVtas">VTA's</a>
      </nav>
      <button id="enableSound" class="btn">Enable sound</button>
    </div>
  </div>

  <!-- MAIN content -->
  <div id="pageDashboard" class="page">
    <div class="grid">
      <!-- Left column -->
      <div>
        <div id="loginCard" class="card">
          <h3>Inloggen</h3>
          <div class="small">Vul naam en roepnummer in (bv. 34-101)</div>
          <div class="field"><input id="inputName" placeholder="Naam"></div>
          <div class="field"><input id="inputRoep" placeholder="Roepnummer"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="btnLogin" class="btn">Inloggen</button>
            <button id="btnLogout" class="btn ghost" style="display:none">Uitloggen</button>
          </div>
        </div>

        <div id="controlCard" class="card" style="display:none;margin-top:12px">
          <h3>Controlepaneel</h3>
          <div id="currentUser" class="small" style="margin-bottom:8px"></div>

          <div class="field">
            <label class="small">Status</label>
            <select id="statusSelect" class="select-status">
              <option value="1">1 â€” Inzetbaar, vrij</option>
              <option value="2">2 â€” Aanrijdend naar de melding</option>
              <option value="3">3 â€” Ter plaatse</option>
              <option value="4">4 â€” Bezet, max 30 minuten</option>
              <option value="5">5 â€” Transport aanvraag</option>
              <option value="6">6 â€” Aanvraag OC</option>
              <option value="7">7 â€” Spoed aanvraag OC</option>
              <option value="8">8 â€” Uitdienst</option>
            </select>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="btnSetStatus" class="btn">Wijzig status</button>
            <button id="btnToggleDienst" class="btn ghost">In / Uit dienst</button>
          </div>

          <div style="margin-top:14px">
            <button id="btnNood" class="huge nood">ðŸš¨ NOODKNOP</button>
          </div>

          <div style="margin-top:12px">
            <button id="btnResetNood" class="btn ghost">Reset nood (OVD)</button>
            <button id="btnResetDienst" class="btn ghost">Reset dienst (wis alle gebruikers)</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Uitleg</h3>
          <p class="small">Gebruik de noodknop alleen bij echte incidenten. Alarm verschijnt voor iedereen en blijft knipperen totdat iemand het reset.</p>
        </div>
      </div>

      <!-- Right column -->
      <aside>
        <div class="card">
          <h3>OVD / Live overzicht</h3>
          <div class="small">Gesorteerd op status (1 â†’ 8)</div>
          <div id="ovdList" class="ovd-list" style="margin-top:10px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Quick actions</h3>
          <div style="display:flex;gap:8px">
            <button id="openVta" class="btn ghost">Open VTA-pagina</button>
            <button id="downloadCSV" class="btn ghost">Download CSV</button>
          </div>
          <div class="small" style="margin-top:8px">Download of open VTA beheer voor dieptebeheer.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- VTA page -->
  <div id="pageVtas" class="page" style="display:none">
    <div class="card">
      <h3>VTA Beheer</h3>
      <div class="small">Voeg VTA's toe of bewerk bestaande. Alles is realtime.</div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="vtaNaam" placeholder="Naam">
        <input id="vtaRoep" placeholder="Roepnummer">
        <select id="vtaStatus">
          <option value="1">1 - Inzetbaar</option>
          <option value="2">2 - Aanrijdend</option>
          <option value="3">3 - Ter plaatse</option>
          <option value="4">4 - Bezet</option>
          <option value="5">5 - Transport</option>
          <option value="6">6 - Aanvraag OC</option>
          <option value="7">7 - Spoed OC</option>
          <option value="8">8 - Uitdienst</option>
        </select>
        <button id="btnAddVta" class="btn">Voeg toe</button>
      </div>

      <div style="margin-top:12px; overflow:auto; max-height:420px;">
        <table class="table" id="vtaTable" style="width:100%">
          <thead><tr><th>Naam</th><th>Roep</th><th>Status</th><th>Dienst</th><th>Acties</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">Â© Nederbeek â€” Meldkamer</div>
</div>

<!-- ALERT OVERLAY -->
<div id="alertOverlay" title="Klik om te resetten">
  <div>
    <h2>ðŸš¨ NOODALARM ðŸš¨</h2>
    <p id="alertDetail">â€”</p>
    <div style="margin-top:18px">
      <button id="closeAlert" class="btn" style="background:#fff;color:#001b35">Stop alarm</button>
    </div>
  </div>
</div>

<!-- AUDIO: harde alarm (optie 3) -->
<audio id="alarmAudio" loop preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<!-- FIREBASE compat (v8 CDN voor Pages compatibility) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<!-- =========================
     JAVASCRIPT - LOGICA
     ========================= -->
<script>
/* -------------------------
   Firebase config (jouw project)
   ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBa_2hGKhEH_dU6xDIfIjIO8_BlubM-JSc",
  authDomain: "politie-nederbeek-fd6ff.firebaseapp.com",
  databaseURL: "https://politie-nederbeek-fd6ff-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "politie-nederbeek-fd6ff",
  storageBucket: "politie-nederbeek-fd6ff.firebasestorage.app",
  messagingSenderId: "49112852872",
  appId: "1:49112852872:web:9b235d5e5dfd2c89aaf23d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* -------------------------
   DOM refs
   ------------------------- */
const navDashboard = document.getElementById('navDashboard');
const navVtas = document.getElementById('navVtas');
const pageDashboard = document.getElementById('pageDashboard');
const pageVtas = document.getElementById('pageVtas');
const enableSound = document.getElementById('enableSound');
const alarmAudio = document.getElementById('alarmAudio');
const alertOverlay = document.getElementById('alertOverlay');
const alertDetail = document.getElementById('alertDetail');
const closeAlert = document.getElementById('closeAlert');

const inputName = document.getElementById('inputName');
const inputRoep = document.getElementById('inputRoep');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const loginCard = document.getElementById('loginCard');
const controlCard = document.getElementById('controlCard');
const currentUserText = document.getElementById('currentUser');
const btnSetStatus = document.getElementById('btnSetStatus');
const btnToggleDienst = document.getElementById('btnToggleDienst');
const btnNood = document.getElementById('btnNood');
const btnResetNood = document.getElementById('btnResetNood');
const btnResetDienst = document.getElementById('btnResetDienst');
const statusSelect = document.getElementById('statusSelect');
const ovdList = document.getElementById('ovdList');
const openVta = document.getElementById('openVta');
const downloadCSV = document.getElementById('downloadCSV');

/* VTA refs */
const vtaNaam = document.getElementById('vtaNaam');
const vtaRoep = document.getElementById('vtaRoep');
const vtaStatus = document.getElementById('vtaStatus');
const btnAddVta = document.getElementById('btnAddVta');
const vtaTableBody = document.querySelector('#vtaTable tbody');

/* -------------------------
   State
   ------------------------- */
let current = null; // {naam, roep}
let soundEnabled = false;

/* -------------------------
   Navigation (simple hash)
   ------------------------- */
function showPage(page){
  navDashboard.classList.remove('active');
  navVtas.classList.remove('active');
  pageDashboard.style.display = 'none';
  pageVtas.style.display = 'none';
  if (page === 'vtas') {
    navVtas.classList.add('active');
    pageVtas.style.display = 'block';
  } else {
    navDashboard.classList.add('active');
    pageDashboard.style.display = 'block';
  }
}
window.addEventListener('hashchange', () => {
  const h = location.hash.replace('#','') || 'dashboard';
  showPage(h);
});
document.getElementById('navDashboard').addEventListener('click',()=>{location.hash='dashboard'});
document.getElementById('navVtas').addEventListener('click',()=>{location.hash='vtas'});
openVta.addEventListener('click',()=>{location.hash='vtas'});

/* initialize default page */
if (!location.hash) location.hash = '#dashboard';
showPage(location.hash.replace('#','') || 'dashboard');

/* -------------------------
   Enable sound helper
   ------------------------- */
enableSound.addEventListener('click', () => {
  alarmAudio.play().then(()=>{ alarmAudio.pause(); alarmAudio.currentTime = 0; soundEnabled = true; enableSound.style.display='none'; alert('Geluid ingeschakeld voor deze tab.'); })
  .catch(()=>{ alert('Autoplay geblokkeerd â€” probeer nogmaals te klikken.'); });
});

/* -------------------------
   LOGIN / LOGOUT
   ------------------------- */
btnLogin.addEventListener('click', async () => {
  const naam = inputName.value.trim();
  const roep = inputRoep.value.trim();
  if (!naam || !roep) return alert('Vul naam en roepnummer in');
  try {
    await auth.signInAnonymously();
    current = {naam, roep};
    await db.ref('gebruikers/' + roep).update({naam, roep, status:1, dienst:'in', timestamp: Date.now()});
    loginCard.style.display = 'none';
    controlCard.style.display = 'block';
    btnLogout.style.display = 'inline-block';
    currentUserText.innerText = `${naam} (${roep})`;
    localStorage.setItem('nb_user', JSON.stringify(current));
  } catch(e){ console.error(e); alert('Login mislukt: '+e.message); }
});

btnLogout.addEventListener('click', async () => {
  if (!current) return;
  await db.ref('gebruikers/' + current.roep).remove().catch(()=>{});
  current = null;
  loginCard.style.display = 'block';
  controlCard.style.display = 'none';
  btnLogout.style.display = 'none';
  localStorage.removeItem('nb_user');
});

/* restore local values (not auto login) */
(function restore(){
  const s = localStorage.getItem('nb_user');
  if (s) {
    try { const u = JSON.parse(s); inputName.value=u.naam; inputRoep.value=u.roep; } catch(e){}
  }
})();

/* -------------------------
   STATUS meta (color + label)
   ------------------------- */
function statusMeta(s) {
  switch(Number(s)){
    case 1: return {color:'#007f0e', label:'1 â€” Inzetbaar'};
    case 2: return {color:'#005bbb', label:'2 â€” Aanrijdend'};
    case 3: return {color:'#003f7f', label:'3 â€” Ter plaatse'};
    case 4: return {color:'#c79400', label:'4 â€” Bezet'};
    case 5: return {color:'#5e00a8', label:'5 â€” Transport'};
    case 6: return {color:'#c14d00', label:'6 â€” Aanvraag OC'};
    case 7: return {color:'#8b0000', label:'7 â€” Spoed OC'};
    case 8: return {color:'#1c1c1c', label:'8 â€” Uitdienst'};
    default: return {color:'#666', label:'Onbekend'};
  }
}

/* -------------------------
   Set status
   ------------------------- */
document.getElementById('btnSetStatus').addEventListener('click', async () => {
  if (!current) return alert('Niet ingelogd');
  const s = Number(statusSelect.value);
  await db.ref('gebruikers/' + current.roep).update({status: s, timestamp: Date.now()});
});

/* -------------------------
   Toggle dienst
   ------------------------- */
btnToggleDienst.addEventListener('click', async () => {
  if (!current) return alert('Niet ingelogd');
  const userRef = db.ref('gebruikers/' + current.roep);
  userRef.once('value', async snap => {
    const data = snap.val() || {};
    const newDienst = data.dienst === 'in' ? 'uit' : 'in';
    await userRef.update({dienst: newDienst, timestamp: Date.now()});
  });
});

/* -------------------------
   Noodknop: zet db waarde + probeer lokaal te spelen
   ------------------------- */
btnNood.addEventListener('click', async () => {
  if (!current) return alert('Niet ingelogd');
  await db.ref('noodmelding').set({actief:true, door: current.roep, tijd: Date.now()});
  if (soundEnabled) { try { await alarmAudio.play(); } catch(e){} }
});

/* Reset functies */
btnResetNood.addEventListener('click', async () => {
  if (!confirm('Reset noodmelding?')) return;
  await db.ref('noodmelding').set({actief:false, door:'', tijd:0});
});
btnResetDienst.addEventListener('click', async () => {
  if (!confirm('Weet je zeker? Dit verwijdert alle gebruikers.')) return;
  await db.ref('gebruikers').remove();
  alert('Dienst gereset');
});

/* -------------------------
   Alert overlay: click to reset (also close button)
   ------------------------- */
closeAlert.addEventListener('click', async (e) => {
  e.stopPropagation();
  await db.ref('noodmelding').set({actief:false, door:'', tijd:0});
});
alertOverlay.addEventListener('click', async () => {
  await db.ref('noodmelding').set({actief:false, door:'', tijd:0});
});

/* -------------------------
   Listen realtime to noodmelding
   - show overlay and play alarm (loop)
   - overlay pulses via CSS animation
   ------------------------- */
db.ref('noodmelding').on('value', snap => {
  const d = snap.val();
  if (!d || !d.actief) {
    alertOverlay.style.display = 'none';
    try{ alarmAudio.pause(); alarmAudio.currentTime = 0; }catch(e){}
    return;
  }
  alertDetail.innerText = `Door: ${d.door} â€” ${new Date(d.tijd||0).toLocaleString()}`;
  alertOverlay.style.display = 'flex';
  // try to play; if blocked, user should click "Enable sound"
  alarmAudio.play().catch(()=>{ /* autoplay blocked */ });
});

/* -------------------------
   Live gebruikerslijst (OVD overzicht)
   - sorts by status ascending
   - shows color bar + label
   ------------------------- */
db.ref('gebruikers').on('value', snap => {
  const data = snap.val() || {};
  const arr = Object.values(data || {});
  arr.sort((a,b) => (Number(a.status||9) - Number(b.status||9)) || (''+a.naam).localeCompare(b.naam));
  ovdList.innerHTML = '';
  arr.forEach(u => {
    const meta = statusMeta(u.status);
    const row = document.createElement('div');
    row.className = 'row';
    row.style.background = '#031726';
    row.style.border = '1px solid rgba(255,255,255,0.03)';
    row.innerHTML = `
      <div class="left">
        <div style="width:8px;height:36px;border-radius:6px;background:${meta.color};margin-right:10px"></div>
        <div>
          <div style="font-weight:700">${u.naam} <span style="color:var(--muted);font-weight:500">(${u.roep})</span></div>
          <div class="small">${new Date(u.timestamp||0).toLocaleString()}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="status-badge" style="background:${meta.color}">${meta.label.replace(' â€” ','')}</div>
        <div class="ts">${u.dienst || ''}</div>
      </div>
    `;
    ovdList.appendChild(row);
  });
});

/* -------------------------
   VTA management (add / edit / remove)
   ------------------------- */
btnAddVta.addEventListener('click', async () => {
  const naam = vtaNaam.value.trim();
  const roep = vtaRoep.value.trim();
  const status = Number(vtaStatus.value);
  if (!naam || !roep) return alert('Vul naam en roepnummer in');
  await db.ref('vtas/' + roep).set({naam, roep, status, dienst:'in', timestamp: Date.now()});
  vtaNaam.value=''; vtaRoep.value='';
});

/* render VTAs realtime */
db.ref('vtas').on('value', snap => {
  const data = snap.val() || {};
  vtaTableBody.innerHTML = '';
  Object.values(data).sort((a,b)=> (Number(a.status||9)-Number(b.status||9)) || (''+a.naam).localeCompare(b.naam)).forEach(v => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${v.naam}</td>
                    <td>${v.roep}</td>
                    <td>${statusMeta(v.status).label}</td>
                    <td>${v.dienst || ''}</td>
                    <td class="vta-actions">
                      <button class="btn ghost" onclick="window.editVta('${v.roep}')">Edit</button>
                      <button class="btn ghost" onclick="window.removeVta('${v.roep}')">Remove</button>
                    </td>`;
    vtaTableBody.appendChild(tr);
  });
});

/* expose edit/remove to global */
window.editVta = async function(roep){
  const snap = await db.ref('vtas/' + roep).once('value');
  const v = snap.val();
  if (!v) return alert('Niet gevonden');
  const nieuweNaam = prompt('Nieuwe naam', v.naam);
  if (nieuweNaam === null) return;
  const nieuweStatus = prompt('Nieuwe status (1-8)', v.status);
  if (nieuweStatus === null) return;
  await db.ref('vtas/' + roep).update({naam: nieuweNaam, status: Number(nieuweStatus), timestamp: Date.now()});
};
window.removeVta = async function(roep){
  if (!confirm('Verwijder ' + roep + '?')) return;
  await db.ref('vtas/' + roep).remove();
};

/* -------------------------
   CSV export (gebruikers)
   ------------------------- */
downloadCSV.addEventListener('click', async () => {
  const snap = await db.ref('gebruikers').once('value');
  const data = snap.val() || {};
  const rows = [['Naam','Roepnummer','Status','Dienst','Tijd']];
  Object.values(data).forEach(u => rows.push([u.naam, u.roep, u.status, u.dienst, new Date(u.timestamp||0).toLocaleString()]));
  const csv = rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'gebruikers.csv'; a.click(); URL.revokeObjectURL(url);
});

/* -------------------------
   Small helpers: reset local state when DB clears
   ------------------------- */
db.ref('gebruikers').on('child_removed', ()=>{ /* no-op for now */ });

</script>
</body>
</html>
