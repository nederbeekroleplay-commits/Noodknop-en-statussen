<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Noodknop & Status - Realtime</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --muted:#98a0b3; --accent:#0ea5e9;
  }
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
  .wrap{max-width:1100px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
  input,select,button{font-size:15px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #1f2a38;background:transparent;color:#fff}
  button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#022}
  button.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
  .danger{background:#e11d48;color:#fff}
  .muted{color:var(--muted);font-size:13px}
  .big-nood{background:linear-gradient(180deg,#ff4d4f,#d32f2f);font-size:20px;padding:16px;border-radius:12px;border:none;color:white;width:100%}
  .user-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px}
  .small{font-size:13px;color:var(--muted)}
  /* alert fullscreen */
  #alertOverlay{display:none;position:fixed;inset:0;background:rgba(180,0,0,0.98);z-index:9999;color:white;align-items:center;justify-content:center;text-align:center;padding:30px;flex-direction:column}
  #alertOverlay h2{font-size:48px;margin:6px}
  #enableSound{background:#ffd43b;color:#000;padding:8px;border-radius:8px;border:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Nederbeek â€” Noodknop & Status (Realtime)</h1>
    <div>
      <button id="enableSound" title="Klik Ã©Ã©n keer om geluid in deze tab toe te staan">Enable sound</button>
    </div>
  </header>

  <div class="grid">
    <div>
      <div id="loginCard" class="card">
        <h3>Inloggen</h3>
        <div class="small">Vul je naam en roepnummer in (bijv. 34-101)</div>
        <input id="inputName" placeholder="Naam" />
        <input id="inputRoep" placeholder="Roepnummer" style="margin-top:8px"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLogin">Inloggen</button>
          <button id="btnLogout" class="ghost" style="display:none">Uitloggen</button>
        </div>
      </div>

      <div id="mainCard" class="card" style="display:none; margin-top:12px;">
        <h3>Controlepaneel</h3>
        <div class="small" id="currentUserDisplay"></div>

        <div style="margin-top:12px">
          <label class="small">Status</label>
          <select id="statusSelect">
            <option value="1">1 â€” Inzetbaar, vrij</option>
            <option value="2">2 â€” Aanrijdend naar de melding</option>
            <option value="3">3 â€” Ter plaatse</option>
            <option value="4">4 â€” Bezet, max 30 minuten</option>
            <option value="5">5 â€” Transport aanvraag</option>
            <option value="6">6 â€” Aanvraag OC</option>
            <option value="7">7 â€” Spoed aanvraag OC</option>
            <option value="8">8 â€” Uitdienst</option>
          </select>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="btnSetStatus">Wijzig status</button>
            <button id="btnToggleDienst" class="ghost">Indienst / Uitdienst</button>
          </div>
        </div>

        <div style="margin-top:16px">
          <button id="btnNood" class="big-nood">ðŸš¨ NOODKNOP</button>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Omschrijving</h3>
        <p class="small">Noodknop activeert een hard alarm voor iedereen. Klik op het grote rode scherm om het alarm te stoppen (en de noodmelding in de database te resetten).</p>
      </div>
    </div>

    <aside>
      <div class="card">
        <h3>OVD / Live Overzicht</h3>
        <div class="small">Gesorteerd op status</div>
        <div id="ovdList" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Beheer</h3>
        <div style="display:flex;gap:8px">
          <button id="btnResetDienst" class="ghost">Reset dienst (wis alles)</button>
          <button id="btnResetNood" class="ghost">Reset nood</button>
        </div>
        <div class="small" style="margin-top:8px">Let op: Reset dienst verwijdert gebruikers in de db.</div>
      </div>
    </aside>
  </div>
</div>

<!-- ALERT OVERLAY (klik om te sluiten) -->
<div id="alertOverlay">
  <h2>NOODALARM</h2>
  <div id="alertInfo" style="font-size:22px;margin-top:6px"></div>
  <div style="margin-top:20px">
    <button id="closeAlertBtn" style="padding:12px 18px;background:#000;color:#fff;border-radius:8px">Sluit alarm</button>
  </div>
</div>

<!-- audio: optie 3 (hard alarmgeluid), loop = true -->
<audio id="alarmSound" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<!-- FIREBASE (v9+ modular imports via compat-free approach is trickier on Pages)
     We'll use the modular SDK via modules (works if deployed over https).
     If you had issues before, replace with v8 CDN lines; this code expects modules to work. -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  // ---- jouw firebase-config (gebruik je eigen values of de reeds gebruikte) ----
  const firebaseConfig = {
    apiKey: "AIzaSyBa_2hGKhEH_dU6xDIfIjIO8_BlubM-JSc",
    authDomain: "politie-nederbeek-fd6ff.firebaseapp.com",
    databaseURL: "https://politie-nederbeek-fd6ff-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "politie-nederbeek-fd6ff",
    storageBucket: "politie-nederbeek-fd6ff.firebasestorage.app",
    messagingSenderId: "49112852872",
    appId: "1:49112852872:web:9b235d5e5dfd2c89aaf23d",
    measurementId: "G-5TVFPYEZMS"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  // DOM refs
  const loginCard = document.getElementById('loginCard');
  const mainCard = document.getElementById('mainCard');
  const ovdList = document.getElementById('ovdList');
  const inputName = document.getElementById('inputName');
  const inputRoep = document.getElementById('inputRoep');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnSetStatus = document.getElementById('btnSetStatus');
  const btnToggleDienst = document.getElementById('btnToggleDienst');
  const btnNood = document.getElementById('btnNood');
  const btnResetDienst = document.getElementById('btnResetDienst');
  const btnResetNood = document.getElementById('btnResetNood');
  const enableSoundBtn = document.getElementById('enableSound');
  const alertOverlay = document.getElementById('alertOverlay');
  const alertInfo = document.getElementById('alertInfo');
  const closeAlertBtn = document.getElementById('closeAlertBtn');
  const alarmSound = document.getElementById('alarmSound');

  let currentUser = null; // object {naam, roep}
  let soundEnabled = false;

  // enable sound helper (must be called after user gesture on page)
  enableSoundBtn.addEventListener('click', () => {
    // Play and immediately pause to unlock autoplay policy in many browsers
    alarmSound.play().then(() => {
      alarmSound.pause();
      alarmSound.currentTime = 0;
      soundEnabled = true;
      enableSoundBtn.style.display = 'none';
      alert('Geluid is ingeschakeld voor deze tab. Het alarm kan nu afspelen voor iedereen.');
    }).catch(() => {
      soundEnabled = false;
      alert('Browser blokkeert autoplay â€” probeer nogmaals te klikken of open de pagina opnieuw en klik Enable sound.');
    });
  });

  // LOGIN
  btnLogin.addEventListener('click', async () => {
    const naam = inputName.value.trim();
    const roep = inputRoep.value.trim();
    if (!naam || !roep) return alert('Vul naam en roepnummer in.');

    try {
      await signInAnonymously(auth);
      currentUser = { naam, roep };
      // write user to db
      await update(ref(db, 'gebruikers/' + roep), {
        naam: naam,
        roep: roep,
        status: 1,
        dienst: 'in',
        timestamp: Date.now()
      });
      loginCard.style.display = 'none';
      mainCard.style.display = 'block';
      document.getElementById('currentUserDisplay').innerText = `${naam} (${roep})`;
      btnLogout.style.display = 'inline-block';
    } catch (e) {
      console.error(e);
      alert('Inloggen mislukt: ' + e.message);
    }
  });

  btnLogout.addEventListener('click', async () => {
    if (!currentUser) return;
    // remove user from list on logout (optioneel)
    await remove(ref(db, 'gebruikers/' + currentUser.roep)).catch(()=>{});
    currentUser = null;
    loginCard.style.display = 'block';
    mainCard.style.display = 'none';
    btnLogout.style.display = 'none';
  });

  // Status update
  btnSetStatus.addEventListener('click', async () => {
    if (!currentUser) return alert('Niet ingelogd');
    const s = Number(document.getElementById('statusSelect').value);
    await update(ref(db, 'gebruikers/' + currentUser.roep), { status: s, timestamp: Date.now() });
  });

  // toggle dienst
  btnToggleDienst.addEventListener('click', async () => {
    if (!currentUser) return alert('Niet ingelogd');
    const snap = (await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js')).getDatabase; // noop to keep bundle small - not used
    const refPath = ref(db, 'gebruikers/' + currentUser.roep);
    // read current dienst once
    onValue(refPath, async (s) => {
      const data = s.val();
      const newDienst = data && data.dienst === 'in' ? 'uit' : 'in';
      await update(refPath, { dienst: newDienst, timestamp: Date.now() });
    }, { onlyOnce: true });
  });

  // trigger nood: set in DB + play sound locally (clients listening will also auto-play)
  btnNood.addEventListener('click', async () => {
    if (!currentUser) return alert('Niet ingelogd');
    await update(ref(db, 'noodmelding'), {
      actief: true,
      door: currentUser.roep,
      tijd: Date.now()
    });
    // try to play locally immediately if sound enabled
    if (soundEnabled) {
      try { await alarmSound.play(); } catch(e){ /* autoplay blocked until user interacts, but other clients may have enabled sound */ }
    }
  });

  // reset dienst (wipe users)
  btnResetDienst.addEventListener('click', async () => {
    if (!confirm('Weet je zeker dat je alle gebruikers en statussen wilt verwijderen (einde dienst)?')) return;
    await remove(ref(db, 'gebruikers'));
    alert('Dienst gereset.');
  });

  // reset noodmelding
  btnResetNood.addEventListener('click', async () => {
    await update(ref(db, 'noodmelding'), { actief: false, door: '', tijd: 0 });
  });

  // close alert button
  closeAlertBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    // stop sound locally
    try { alarmSound.pause(); alarmSound.currentTime = 0; } catch(e){}
    // update DB to false (so everyone resets)
    await update(ref(db, 'noodmelding'), { actief: false, door: '', tijd: 0 });
    alertOverlay.style.display = 'none';
  });

  // Also allow clicking overlay itself to close
  document.getElementById('alertOverlay').addEventListener('click', async () => {
    try { alarmSound.pause(); alarmSound.currentTime = 0; } catch(e){}
    await update(ref(db, 'noodmelding'), { actief: false, door: '', tijd: 0 });
    alertOverlay.style.display = 'none';
  });

  // Listen to live 'noodmelding' changes and show overlay + play alarm for everyone
  onValue(ref(db, 'noodmelding'), (snap) => {
    const d = snap.val();
    if (d && d.actief === true) {
      alertOverlay.style.display = 'flex';
      alertInfo.innerText = `Door: ${d.door} â€” ${new Date(d.tijd || 0).toLocaleString()}`;
      // attempt to play alarm for this client
      alarmSound.play().catch(() => {
        // if autoplay blocked, show enable-sound button (already present)
        console.log('Autoplay blocked â€” user must click Enable sound');
      });
    } else {
      alarmSound.pause();
      try { alarmSound.currentTime = 0; } catch(e){}
      alertOverlay.style.display = 'none';
    }
  });

  // Live gebruikerslijst â€” render sorted by status
  onValue(ref(db, 'gebruikers'), (snap) => {
    const data = snap.val() || {};
    const arr = Object.values(data);
    // sort by status ascending (1..8) then name
    arr.sort((a,b) => (a.status - b.status) || (''+a.naam).localeCompare(b.naam));
    ovdList.innerHTML = '';
    arr.forEach(u => {
      const row = document.createElement('div');
      row.className = 'user-row';
      row.style.background = '#071022';
      row.style.border = '1px solid rgba(255,255,255,0.03)';
      row.style.padding = '10px';
      row.style.marginBottom = '8px';
      row.innerHTML = `<div><strong>${u.naam}</strong><div class="small">${u.roep}</div></div><div class="small">Status: ${u.status}</div>`;
      ovdList.appendChild(row);
    });
  });

  // small helper: if a user refreshes page and was logged in previously, you can implement restore via localStorage (optional)
  // e.g. save current user after login: localStorage.setItem('nb_user', JSON.stringify(currentUser));
  // and on load, read it and set currentUser and UI accordingly.
</script>
</body>
</html>
